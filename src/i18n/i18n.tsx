import React, { createContext, useContext, useMemo, useState, useEffect } from 'react';

type Lang = 'ru' | 'kk';

type Dict = Record<string, string>;

const RU: Dict = {
  'nav.home': 'Главная',
  'nav.schedule': 'Расписание',
  'nav.groups': 'Мои группы',
  'nav.profile': 'Профиль',
  'common.loading': 'Загрузка...',
  'common.error': 'Ошибка',
  'common.save': 'Сохранить',
  'common.cancel': 'Отмена',
  'common.delete': 'Удалить',
  'common.back': 'Назад',
  'common.close': 'Закрыть',
  'language.change': 'Сменить язык',
  'language.russian': 'Русский',
  'language.kazakh': 'Қазақша',
  'profile.edit': 'Редактировать',
  'profile.memberships': 'My Memberships',
  'profile.membership.history': 'История абонементов',
  'profile.attendance': 'История посещаемости',
  'profile.payments': 'История платежей',
  'profile.settings': 'Настройки',
  'membership.status.active': 'Активен',
  'membership.status.frozen': 'Заморожен',
  'membership.status.expired': 'Истёк',
  'membership.status.canceled': 'Отменён',
  'membership.pay': 'Оплатить',
  'membership.freeze': 'Заморозить',
  'membership.unfreeze': 'Разморозить',
  'payment.amount': 'Сумма к оплате',
  'payment.card.number': 'Номер карты',
  'payment.card.expiry': 'Срок действия',
  'payment.card.cvv': 'CVV',
  'payment.card.holder': 'Имя держателя карты',
  'payment.process': 'Оплатить',
  'payment.processing': 'Обработка...',
  'freeze.title': 'Заморозить абонемент',
  'freeze.unfreeze.title': 'Разморозить абонемент',
  'freeze.days.available': 'Доступно дней для заморозки',
  'freeze.max.days': 'Максимальный срок заморозки: 30 дней',
  'freeze.start.date': 'Дата начала заморозки',
  'freeze.end.date': 'Дата окончания заморозки',
  'freeze.days.selected': 'Выбрано дней',
  'freeze.process': 'Заморозить',
  'freeze.unfreeze.process': 'Разморозить',
  'attendance.no.visits': 'Посещений нет',
  'attendance.visits.month': 'Посещений за месяц',
  'attendance.missed.month': 'Пропусков за месяц',
  'attendance.average': 'Средняя посещаемость',
  'payments.no.payments': 'No payments yet',
  'payments.view.all': 'View All',
  'payments.status.paid': 'Оплачено',
  'payments.status.pending': 'В обработке',
  'payments.status.failed': 'Ошибка',
  'settings.notifications': 'Уведомления',
  'settings.notifications.desc': 'Оплата, окончание срока, изменения расписания',
  'settings.location': 'Геолокация',
  'settings.location.desc': 'Разрешение на использование геолокации',
  'settings.language': 'Язык',
  'settings.support': 'Поддержка',
  'settings.privacy': 'Политика конфиденциальности',
  'settings.terms': 'Условия предоставления услуг',
  'club.details': 'Детали клуба',
  'club.address': 'Адрес',
  'club.phone': 'Телефон',
  'club.sections': 'Секции и группы',
  'club.pricing': 'Прайсинг',
  'club.buy.membership': 'Приобрести абонемент',
  'no.memberships': 'У вас пока нет активных абонементов',
  'find.club': 'Найти клуб',
  'home.checkin.title': 'Slide to Check-In',
  'home.checkin.slide': 'Проведите для отметки посещения',
  'home.checkin.success': 'Посещение отмечено!',
  'home.sessions.title': 'Предстоящие тренировки',
  'home.sessions.empty': 'У вас пока нет предстоящих тренировок.',
  'home.sessions.today': 'Сегодня',
  'home.sessions.tomorrow': 'Завтра',
  'home.sessions.status.scheduled': 'Запланировано',
  'home.sessions.status.cancelled': 'Отменено',
  'home.sessions.status.booked': 'Booked',
  'home.sessions.status.full': 'Запись полная',
  'home.sessions.book': 'Записаться',
  'home.location.distance': 'Вы находитесь в {distance} от клуба.',
  'home.location.meters': 'м',
  'home.location.km': 'км',
  'home.noMembership.title': 'Приобретите абонемент',
  'home.noMembership.description': 'Для использования всех функций приложения необходимо приобрести абонемент в одном из клубов.',
  'home.noMembership.findClub': 'Найти клуб',
  'clubs.title': 'Клубы',
  'clubs.search.placeholder': 'Поиск по названию или тегам...',
  'clubs.filter.all': 'Все клубы',
  'clubs.filter.my': 'Мои клубы',
  'clubs.empty.all': 'Клубы не найдены',
  'clubs.empty.my': 'У вас нет активных абонементов в клубах',
  'clubs.empty.search': 'По вашему запросу ничего не найдено',
  'clubs.card.sections': 'секций',
  'clubs.card.member': 'Участник',
  'clubs.card.buy': 'Купить',
  'clubs.details.info': 'Информация о клубе',
  'clubs.details.address': 'Адрес',
  'clubs.details.hours': 'Часы работы',
  'clubs.details.phone': 'Телефон',
  'clubs.details.sections': 'Секции',
  'clubs.details.memberships': 'Абонементы',
  'clubs.details.purchase': 'Приобрести абонемент',
  'clubs.payment.title': 'Оплата абонемента',
  'clubs.payment.order': 'Ваш заказ',
  'clubs.payment.total': 'К оплате',
  'clubs.payment.customerName': 'ФИО',
  'clubs.payment.cardNumber': 'Номер карты',
  'clubs.payment.expiry': 'Дата (MM/YY)',
  'clubs.payment.cancel': 'Отменить',
  'clubs.payment.pay': 'Оплатить',
  'clubs.payment.processing': 'Обработка платежа...',
  'clubs.payment.errors.name': 'Введите ФИО',
  'clubs.payment.errors.card': 'Введите 16 цифр карты',
  'clubs.payment.errors.expiry': 'Введите корректную дату',
  'clubs.payment.errors.expiryPast': 'Карта просрочена',
  'clubs.payment.errors.cvv': 'Введите 3 цифры CVV',
  'clubs.payment.success.title': 'Оплата прошла успешно!',
  'clubs.payment.success.description': 'Абонемент активирован. Вы можете начать тренировки.',
  'clubs.payment.success.button': 'Вернуться на главную',
  'clubs.payment.success.redirect': 'Автоматический переход через 5 секунд...',
  'clubs.payment.error.title': 'Ошибка оплаты',
  'clubs.payment.error.description': 'Не удалось провести платёж. Попробуйте ещё раз или используйте другую карту.',
  'clubs.payment.error.retry': 'Попробовать снова',
  'common.retry': 'Повторить',
  'schedule.tabs.list': 'Список',
  'schedule.tabs.calendar': 'Календарь',
  'schedule.filters': 'Фильтры',
  'schedule.filters.club': 'Клуб',
  'schedule.filters.allClubs': 'Все клубы',
  'schedule.filters.sections': 'Секции',
  'schedule.filters.allSections': 'Все секции',
  'schedule.filters.mySections': 'Мои секции',
  'schedule.filters.trainer': 'Тренер',
  'schedule.filters.allTrainers': 'Все тренеры',
  'schedule.filters.reset': 'Сбросить',
  'schedule.filters.apply': 'Применить',
  'schedule.noTrainings': 'Нет ближайших тренировок',
  'schedule.noTrainingsOnDate': 'Нет тренировок на эту дату',
  'schedule.error': 'Не удалось загрузить расписание. Попробуйте позже.',
  'schedule.today': 'Сегодня',
  'schedule.tomorrow': 'Завтра',
  'schedule.weekdays.mon': 'Пн',
  'schedule.weekdays.tue': 'Вт',
  'schedule.weekdays.wed': 'Ср',
  'schedule.weekdays.thu': 'Чт',
  'schedule.weekdays.fri': 'Пт',
  'schedule.weekdays.sat': 'Сб',
  'schedule.weekdays.sun': 'Вс',
  'schedule.months.jan': 'Январь',
  'schedule.months.feb': 'Февраль',
  'schedule.months.mar': 'Март',
  'schedule.months.apr': 'Апрель',
  'schedule.months.may': 'Май',
  'schedule.months.jun': 'Июнь',
  'schedule.months.jul': 'Июль',
  'schedule.months.aug': 'Август',
  'schedule.months.sep': 'Сентябрь',
  'schedule.months.oct': 'Октябрь',
  'schedule.months.nov': 'Ноябрь',
  'schedule.months.dec': 'Декабрь',
  'schedule.participants': 'участников',
  'schedule.spotsLeft': 'мест осталось',
  'schedule.booked': 'Вы записаны',
  'schedule.inWaitlist': 'В списке ожидания',
  'schedule.book': 'Записаться',
  'schedule.cancelBooking': 'Отменить запись',
  'schedule.cancelTooLate': 'Нельзя отменить запись менее чем за 1 час до тренировки',
  'schedule.notifyMe': 'Сообщить мне',
  'schedule.showParticipants': 'Показать',
  'schedule.noMembership.title': 'Нет активного абонемента',
  'schedule.noMembership.description': 'Для записи на тренировку необходимо приобрести абонемент.',
  'schedule.noMembership.buyButton': 'Приобрести абонемент',
  'schedule.participants.title': 'Участники тренировки',
  'schedule.participants.you': 'Вы',
  'schedule.participants.empty': 'Пока нет записавшихся',
  'schedule.participants.count': '{current} из {max} участников',
};

const KK: Dict = {
  'nav.home': 'Басты бет',
  'nav.schedule': 'Кесте',
  'nav.groups': 'Менің топтарым',
  'nav.profile': 'Профиль',
  'common.loading': 'Жүктелуде...',
  'common.error': 'Қате',
  'common.save': 'Сақтау',
  'common.cancel': 'Бас тарту',
  'common.delete': 'Жою',
  'common.back': 'Артқа',
  'common.close': 'Жабу',
  'language.change': 'Тілді өзгерту',
  'language.russian': 'Орысша',
  'language.kazakh': 'Қазақша',
  'profile.edit': 'Өңдеу',
  'profile.memberships': 'Менің абонементтерім',
  'profile.membership.history': 'Абонемент тарихы',
  'profile.attendance': 'Қатысу тарихы',
  'profile.payments': 'Төлем тарихы',
  'profile.settings': 'Баптаулар',
  'membership.status.active': 'Белсенді',
  'membership.status.frozen': 'Қатып қалған',
  'membership.status.expired': 'Мерзімі өткен',
  'membership.status.canceled': 'Күшін жойған',
  'membership.pay': 'Төлеу',
  'membership.freeze': 'Қатып қалдыру',
  'membership.unfreeze': 'Еріту',
  'payment.amount': 'Төлем сомасы',
  'payment.card.number': 'Карта нөмірі',
  'payment.card.expiry': 'Мерзімі',
  'payment.card.cvv': 'CVV',
  'payment.card.holder': 'Карта иесінің аты',
  'payment.process': 'Төлеу',
  'payment.processing': 'Өңделуде...',
  'freeze.title': 'Абонементті қатып қалдыру',
  'freeze.unfreeze.title': 'Абонементті еріту',
  'freeze.days.available': 'Қатып қалдыруға қолжетімді күндер',
  'freeze.max.days': 'Максималды мерзім: 30 күн',
  'freeze.start.date': 'Қатып қалдыру басталу күні',
  'freeze.end.date': 'Қатып қалдыру аяқталу күні',
  'freeze.days.selected': 'Таңдалған күндер',
  'freeze.process': 'Қатып қалдыру',
  'freeze.unfreeze.process': 'Еріту',
  'attendance.no.visits': 'Барулар жоқ',
  'attendance.visits.month': 'Айына барулар',
  'attendance.missed.month': 'Айына жіберілгендер',
  'attendance.average': 'Орташа қатысу',
  'payments.no.payments': 'Төлемдер жоқ',
  'payments.view.all': 'Барлығын көру',
  'payments.status.paid': 'Төленген',
  'payments.status.pending': 'Өңделуде',
  'payments.status.failed': 'Қате',
  'settings.notifications': 'Хабарландырулар',
  'settings.notifications.desc': 'Төлем, мерзім аяқталуы, кесте өзгерістері',
  'settings.location': 'Геолокация',
  'settings.location.desc': 'Геолокацияны пайдалануға рұқсат',
  'settings.language': 'Тіл',
  'settings.support': 'Қолдау',
  'settings.privacy': 'Құпиялылық саясаты',
  'settings.terms': 'Қызмет көрсету шарттары',
  'club.details': 'Клуб детальдары',
  'club.address': 'Мекен-жайы',
  'club.phone': 'Телефон',
  'club.sections': 'Бөлімдер мен топтар',
  'club.pricing': 'Баға белгілеу',
  'club.buy.membership': 'Абонемент сатып алу',
  'no.memberships': 'Сізде әлі белсенді абонементтер жоқ',
  'find.club': 'Клуб табу',
  'home.checkin.title': 'Check-In үшін сырғытыңыз',
  'home.checkin.slide': 'Қатысу үшін сырғытыңыз',
  'home.checkin.success': 'Қатысу белгіленді!',
  'home.sessions.title': 'Алдағы жаттығулар',
  'home.sessions.empty': 'Сізде әлі алдағы жаттығулар жоқ.',
  'home.sessions.today': 'Бүгін',
  'home.sessions.tomorrow': 'Ертең',
  'home.sessions.status.scheduled': 'Жоспарланған',
  'home.sessions.status.cancelled': 'Күшін жойған',
  'home.sessions.status.booked': 'Booked',
  'home.sessions.status.full': 'Жазылу толық',
  'home.sessions.book': 'Жазылу',
  'home.location.distance': 'Сіз клубтан {distance} қашықтықтасыз.',
  'home.location.meters': 'м',
  'home.location.km': 'км',
  'home.noMembership.title': 'Абонемент сатып алыңыз',
  'home.noMembership.description': 'Қолданбаның барлық функцияларын пайдалану үшін клубтардың бірінде абонемент сатып алу қажет.',
  'home.noMembership.findClub': 'Клуб табу',
  'clubs.title': 'Клубтар',
  'clubs.search.placeholder': 'Атау немесе тегтер бойынша іздеу...',
  'clubs.filter.all': 'Барлық клубтар',
  'clubs.filter.my': 'Менің клубтарым',
  'clubs.empty.all': 'Клубтар табылмады',
  'clubs.empty.my': 'Сізде клубтарда белсенді абонементтер жоқ',
  'clubs.empty.search': 'Сіздің сұрауыңыз бойынша ештеңе табылмады',
  'clubs.card.sections': 'бөлім',
  'clubs.card.member': 'Қатысушы',
  'clubs.card.buy': 'Сатып алу',
  'clubs.details.info': 'Клуб туралы ақпарат',
  'clubs.details.address': 'Мекенжай',
  'clubs.details.hours': 'Жұмыс уақыты',
  'clubs.details.phone': 'Телефон',
  'clubs.details.sections': 'Бөлімдер',
  'clubs.details.memberships': 'Абонементтер',
  'clubs.details.purchase': 'Абонемент сатып алу',
  'clubs.payment.title': 'Абонементті төлеу',
  'clubs.payment.order': 'Сіздің тапсырысыңыз',
  'clubs.payment.total': 'Төлем',
  'clubs.payment.customerName': 'Аты-жөні',
  'clubs.payment.cardNumber': 'Карта нөмірі',
  'clubs.payment.expiry': 'Күні (MM/YY)',
  'clubs.payment.cancel': 'Бас тарту',
  'clubs.payment.pay': 'Төлеу',
  'clubs.payment.processing': 'Төлем өңделуде...',
  'clubs.payment.errors.name': 'Аты-жөніңізді енгізіңіз',
  'clubs.payment.errors.card': 'Картаның 16 санын енгізіңіз',
  'clubs.payment.errors.expiry': 'Дұрыс күнді енгізіңіз',
  'clubs.payment.errors.expiryPast': 'Карта мерзімі өткен',
  'clubs.payment.errors.cvv': 'CVV 3 санын енгізіңіз',
  'clubs.payment.success.title': 'Төлем сәтті өтті!',
  'clubs.payment.success.description': 'Абонемент белсендірілді. Сіз жаттығуларды бастай аласыз.',
  'clubs.payment.success.button': 'Басты бетке оралу',
  'clubs.payment.success.redirect': '5 секундтан кейін автоматты түрде өту...',
  'clubs.payment.error.title': 'Төлем қатесі',
  'clubs.payment.error.description': 'Төлемді жүргізу мүмкін болмады. Қайтадан көріңіз немесе басқа картаны пайдаланыңыз.',
  'clubs.payment.error.retry': 'Қайтадан көру',
  'common.retry': 'Қайталау',
  'schedule.tabs.list': 'Тізім',
  'schedule.tabs.calendar': 'Күнтізбе',
  'schedule.filters': 'Сүзгілер',
  'schedule.filters.club': 'Клуб',
  'schedule.filters.allClubs': 'Барлық клубтар',
  'schedule.filters.sections': 'Бөлімдер',
  'schedule.filters.allSections': 'Барлық бөлімдер',
  'schedule.filters.mySections': 'Менің бөлімдерім',
  'schedule.filters.trainer': 'Жаттықтырушы',
  'schedule.filters.allTrainers': 'Барлық жаттықтырушылар',
  'schedule.filters.reset': 'Қалпына келтіру',
  'schedule.filters.apply': 'Қолдану',
  'schedule.noTrainings': 'Жақын жаттығулар жоқ',
  'schedule.noTrainingsOnDate': 'Бұл күнге жаттығулар жоқ',
  'schedule.error': 'Кестені жүктеу мүмкін болмады. Кейінірек көріңіз.',
  'schedule.today': 'Бүгін',
  'schedule.tomorrow': 'Ертең',
  'schedule.weekdays.mon': 'Дс',
  'schedule.weekdays.tue': 'Сс',
  'schedule.weekdays.wed': 'Ср',
  'schedule.weekdays.thu': 'Бс',
  'schedule.weekdays.fri': 'Жм',
  'schedule.weekdays.sat': 'Сн',
  'schedule.weekdays.sun': 'Жс',
  'schedule.months.jan': 'Қаңтар',
  'schedule.months.feb': 'Ақпан',
  'schedule.months.mar': 'Наурыз',
  'schedule.months.apr': 'Сәуір',
  'schedule.months.may': 'Мамыр',
  'schedule.months.jun': 'Маусым',
  'schedule.months.jul': 'Шілде',
  'schedule.months.aug': 'Тамыз',
  'schedule.months.sep': 'Қыркүйек',
  'schedule.months.oct': 'Қазан',
  'schedule.months.nov': 'Қараша',
  'schedule.months.dec': 'Желтоқсан',
  'schedule.participants': 'қатысушы',
  'schedule.spotsLeft': 'орын қалды',
  'schedule.booked': 'Сіз жазылдыңыз',
  'schedule.inWaitlist': 'Күту тізімінде',
  'schedule.book': 'Жазылу',
  'schedule.cancelBooking': 'Жазылуды болдырмау',
  'schedule.cancelTooLate': 'Жаттығуға 1 сағаттан аз уақыт қалғанда жазылуды болдырмауға болмайды',
  'schedule.notifyMe': 'Маған хабарлаңыз',
  'schedule.showParticipants': 'Көрсету',
  'schedule.noMembership.title': 'Белсенді абонемент жоқ',
  'schedule.noMembership.description': 'Жаттығуға жазылу үшін абонемент сатып алу қажет.',
  'schedule.noMembership.buyButton': 'Абонемент сатып алу',
  'schedule.participants.title': 'Жаттығу қатысушылары',
  'schedule.participants.you': 'Сіз',
  'schedule.participants.empty': 'Әзірге жазылғандар жоқ',
  'schedule.participants.count': '{max} қатысушының {current}',
};

const dictionaries: Record<Lang, Dict> = { ru: RU, kk: KK };

type I18nContextType = {
  lang: Lang;
  setLang: (l: Lang) => void;
  t: (key: string, params?: Record<string, string | number>) => string;
};

const I18nContext = createContext<I18nContextType | undefined>(undefined);

export const I18nProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [lang, setLangState] = useState<Lang>('ru');

  useEffect(() => {
    const stored = localStorage.getItem('appLang') as Lang | null;
    if (stored === 'ru' || stored === 'kk') {
      setLangState(stored);
    } else {
      // Initialize from Telegram or browser language
      const tg = window.Telegram?.WebApp;
      const browserLang = navigator.language?.toLowerCase();
      const tgLang = (tg && tg.initDataUnsafe && (tg.initDataUnsafe as { user?: { language_code?: string } }).user?.language_code) || undefined;
      const effective = (tgLang || browserLang || 'ru').toLowerCase();
      setLangState(effective.startsWith('kk') ? 'kk' : 'ru');
    }
  }, []);

  const setLang = (l: Lang) => {
    setLangState(l);
    localStorage.setItem('appLang', l);
  };

  const t = useMemo(() => {
    return (key: string, params?: Record<string, string | number>) => {
      const dict = dictionaries[lang] || RU;
      let result = dict[key] || key;
      if (params) {
        Object.entries(params).forEach(([k, v]) => {
          result = result.replace(new RegExp(`\\{${k}\\}`, 'g'), String(v));
        });
      }
      return result;
    };
  }, [lang]);

  // Reflect current language on the <html> tag to influence native pickers (Android/Chrome) and a11y
  useEffect(() => {
    const html = document.documentElement;
    html.setAttribute('lang', lang === 'kk' ? 'kk-KZ' : 'ru-RU');
  }, [lang]);

  const value = useMemo(() => ({ lang, setLang, t }), [lang, t]);

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
};

export const useI18n = () => {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
};
